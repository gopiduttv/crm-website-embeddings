<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lead-Focused Tracking Test - v2.0</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: #f8f9fa;
      color: #212529;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    h1 { 
      color: #0066cc; 
      margin-top: 0; 
      font-size: 28px;
      border-bottom: 3px solid #0066cc;
      padding-bottom: 10px;
    }
    h2 { 
      color: #333; 
      border-bottom: 2px solid #e9ecef; 
      padding-bottom: 10px;
      margin-top: 0;
    }
    h3 { color: #555; margin-top: 20px; }
    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: bold;
      margin-left: 8px;
    }
    .badge-success { background: #d4edda; color: #155724; }
    .badge-warning { background: #fff3cd; color: #856404; }
    .badge-danger { background: #f8d7da; color: #721c24; }
    .badge-info { background: #d1ecf1; color: #0c5460; }
    .status {
      padding: 15px;
      border-radius: 6px;
      margin: 10px 0;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .status-enabled { background: #d4edda; color: #155724; border-left: 4px solid #28a745; }
    .status-disabled { background: #f8d7da; color: #721c24; border-left: 4px solid #dc3545; }
    .info-box {
      background: #e7f3ff;
      border-left: 4px solid #0066cc;
      padding: 15px;
      border-radius: 4px;
      margin: 15px 0;
    }
    .warning-box {
      background: #fff3cd;
      border-left: 4px solid #ffc107;
      padding: 15px;
      border-radius: 4px;
      margin: 15px 0;
    }
    .success-box {
      background: #d4edda;
      border-left: 4px solid #28a745;
      padding: 15px;
      border-radius: 4px;
      margin: 15px 0;
    }
    button {
      background: #0066cc;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      margin: 5px;
      transition: all 0.2s;
    }
    button:hover { background: #0052a3; transform: translateY(-1px); }
    button:active { transform: translateY(0); }
    button.btn-danger { background: #dc3545; }
    button.btn-danger:hover { background: #c82333; }
    button.btn-success { background: #28a745; }
    button.btn-success:hover { background: #218838; }
    button.btn-secondary { background: #6c757d; }
    button.btn-secondary:hover { background: #5a6268; }
    button.btn-reload { background: #17a2b8; font-size: 16px; padding: 12px 24px; }
    button.btn-reload:hover { background: #138496; }
    form {
      display: flex;
      flex-direction: column;
      gap: 15px;
      max-width: 600px;
      margin-top: 15px;
    }
    label {
      font-weight: 600;
      color: #495057;
      margin-bottom: 5px;
    }
    input, textarea, select {
      padding: 10px 12px;
      border: 2px solid #ced4da;
      border-radius: 6px;
      font-size: 14px;
      transition: border-color 0.2s;
    }
    input:focus, textarea:focus, select:focus {
      outline: none;
      border-color: #0066cc;
      box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.1);
    }
    pre {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 6px;
      overflow-x: auto;
      font-size: 12px;
      border: 1px solid #dee2e6;
    }
    .test-scenario {
      background: #fff;
      border: 2px solid #e9ecef;
      border-radius: 6px;
      padding: 20px;
      margin: 15px 0;
    }
    .test-scenario h4 {
      margin-top: 0;
      color: #0066cc;
    }
    .test-steps {
      list-style: none;
      padding: 0;
      counter-reset: step;
    }
    .test-steps li {
      counter-increment: step;
      padding: 10px;
      margin: 8px 0;
      background: #f8f9fa;
      border-radius: 4px;
      position: relative;
      padding-left: 45px;
    }
    .test-steps li::before {
      content: counter(step);
      position: absolute;
      left: 12px;
      top: 10px;
      background: #0066cc;
      color: white;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 12px;
    }
    .config-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }
    .config-card {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 6px;
      border: 1px solid #dee2e6;
    }
    .config-card h4 {
      margin: 0 0 10px 0;
      color: #495057;
      font-size: 14px;
    }
    .config-value {
      font-family: 'Courier New', monospace;
      font-size: 13px;
      color: #0066cc;
      font-weight: 600;
    }
    code {
      background: #f8f9fa;
      padding: 2px 6px;
      border-radius: 3px;
      font-family: 'Courier New', monospace;
      color: #e83e8c;
      font-size: 13px;
    }
    .event-log {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 15px;
      border-radius: 6px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      max-height: 300px;
      overflow-y: auto;
      margin-top: 10px;
    }
    .event-log .event {
      margin: 5px 0;
      padding: 5px;
      border-left: 3px solid #0066cc;
      padding-left: 10px;
    }
    .event-log .event.blur { border-left-color: #28a745; }
    .event-log .event.beforeunload { border-left-color: #ffc107; }
    .event-log .event.submission { border-left-color: #0066cc; }
    .highlight {
      background: yellow;
      padding: 2px 4px;
      font-weight: bold;
    }
  </style>
  
  <!-- YourCRM Tracking Script v2.0 -->
  <script src="http://localhost:5000/script/abc-123.js" async defer></script>
</head>
<body>
  <div class="container">
    <h1>üéØ Lead-Focused Tracking Test Page <span class="badge badge-info">v2.0</span></h1>
    <p style="font-size: 16px; color: #666;">
      This page demonstrates the new <strong>lead-focused tracking system</strong> that captures 
      complete and partial leads through form submissions and field interactions.
    </p>
    
    <div class="warning-box">
      <strong>‚ö° Key Features Tested:</strong>
      <ul style="margin: 10px 0 0 0;">
        <li>‚úÖ <strong>blur</strong> event - Captures when user leaves a field</li>
        <li>‚úÖ <strong>beforeunload</strong> event - Captures abandoned fields when tab closes</li>
        <li>‚úÖ <strong>change</strong> event - Captures dropdown/checkbox/radio changes</li>
        <li>‚úÖ Form submission tracking with complete lead data</li>
        <li>‚úÖ Chat widget with contact info collection</li>
        <li>‚ùå Page view tracking (disabled - no lead value)</li>
        <li>‚ùå Click tracking (disabled - no lead value)</li>
      </ul>
    </div>
  </div>

  <div class="container">
    <h2>üìä Current Configuration Status</h2>
    <div id="status-display">
      <p style="color: #999;">Loading configuration...</p>
    </div>

    <div class="config-grid" id="config-details" style="display: none;">
      <div class="config-card">
        <h4>Form Tracking</h4>
        <div class="config-value" id="forms-enabled">-</div>
      </div>
      <div class="config-card">
        <h4>Field Interactions</h4>
        <div class="config-value" id="track-interactions">-</div>
      </div>
      <div class="config-card">
        <h4>Blur Trigger</h4>
        <div class="config-value" id="trigger-blur">-</div>
      </div>
      <div class="config-card">
        <h4>Beforeunload Trigger</h4>
        <div class="config-value" id="trigger-beforeunload">-</div>
      </div>
      <div class="config-card">
        <h4>Tracked Fields</h4>
        <div class="config-value" id="track-fields">-</div>
      </div>
      <div class="config-card">
        <h4>Batch Size</h4>
        <div class="config-value" id="batch-size">-</div>
      </div>
    </div>
  </div>

  <div class="container">
    <h2>üéÆ Configuration Controls</h2>
    
    <h3>Quick Actions</h3>
    <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px;">
      <button class="btn-success" onclick="enableLeadTracking()">‚úÖ Enable Lead Tracking</button>
      <button class="btn-danger" onclick="disableLeadTracking()">‚ùå Disable Lead Tracking</button>
      <button class="btn-secondary" onclick="viewConfig()">üìã View Full Config</button>
    </div>

    <div class="info-box">
      <strong>üí° Remember:</strong> Configuration changes require a page reload to take effect. 
      The tracking script loads config once when the page initializes.
    </div>

    <button class="btn-reload" onclick="location.reload()">üîÑ Reload Page to Apply Changes</button>
  </div>

  <div class="container">
    <h2>üß™ Test Scenarios</h2>

    <div class="test-scenario">
      <h4>Test 1: Complete Form Submission (High-Quality Lead)</h4>
      <p><strong>Expected:</strong> Creates lead with status <code>submitted</code> and quality <code>high</code></p>
      <ul class="test-steps">
        <li>Fill out the contact form completely (email, name, message)</li>
        <li>Click Submit button</li>
        <li>Check Network tab for <code>POST /v1/track/events</code> with <code>type: form_submission</code></li>
        <li>Event should include all field values and form progress (100%)</li>
      </ul>
    </div>

    <div class="test-scenario">
      <h4>Test 2: Field Blur Event (Partial Lead Tracking)</h4>
      <p><strong>Expected:</strong> Sends <code>form_interaction</code> event when leaving each field</p>
      <ul class="test-steps">
        <li>Type your email in the email field</li>
        <li><span class="highlight">Click outside the field or press Tab</span> (triggers blur)</li>
        <li>Check Network tab for <code>POST /v1/track/events</code> with <code>type: form_interaction</code></li>
        <li>Event should include <code>trigger: "blur"</code>, <code>fieldName: "email"</code>, and form progress</li>
      </ul>
    </div>

    <div class="test-scenario">
      <h4>Test 3: Beforeunload Event (Critical for Partial Leads)</h4>
      <p><strong>Expected:</strong> Captures all in-progress fields when tab closes</p>
      <ul class="test-steps">
        <li>Fill email field and name field</li>
        <li><span class="highlight">Keep cursor in the name field (don't click away)</span></li>
        <li>Close the browser tab immediately</li>
        <li>Check server logs for <code>form_interaction</code> event with <code>trigger: "beforeunload"</code></li>
        <li>Event should include BOTH email AND name fields (captured before tab closed)</li>
      </ul>
      <div class="warning-box" style="margin-top: 10px;">
        <strong>‚ö†Ô∏è Why this matters:</strong> Without beforeunload, the last field (name) would be lost 
        because the user never left it (no blur). This is how we achieve 95% capture rate!
      </div>
    </div>

    <div class="test-scenario">
      <h4>Test 4: Dropdown/Checkbox Change Events</h4>
      <p><strong>Expected:</strong> Immediately captures selection changes</p>
      <ul class="test-steps">
        <li>Scroll to the "Inquiry Type" dropdown below</li>
        <li>Select an option (e.g., "Product Demo")</li>
        <li>Check Network tab for <code>form_interaction</code> with <code>trigger: "change"</code></li>
        <li>Event should capture immediately without needing to blur away</li>
      </ul>
    </div>

    <div class="test-scenario">
      <h4>Test 5: Sensitive Field Exclusion</h4>
      <p><strong>Expected:</strong> Password and credit card fields are NOT tracked</p>
      <ul class="test-steps">
        <li>Scroll to the "Sensitive Fields Test" form</li>
        <li>Type in the password field and blur away</li>
        <li>Check Network tab - <strong>NO event should be sent</strong></li>
        <li>Same for credit card field - automatically excluded for privacy</li>
      </ul>
    </div>

    <div class="test-scenario">
      <h4>Test 6: Chat Widget Contact Collection</h4>
      <p><strong>Expected:</strong> Collects email before allowing chat, sends <code>chat_message_sent</code></p>
      <ul class="test-steps">
        <li>Open the chat widget (bottom-right corner)</li>
        <li>Enter your email and name when prompted</li>
        <li>Type a message and send</li>
        <li>Check Network tab for <code>chat_message_sent</code> event with <code>userInfo</code></li>
      </ul>
    </div>
  </div>

  <div class="container">
    <h2>üìù Test Form 1: Contact Form</h2>
    <p style="color: #666;">A standard contact form to test blur events, beforeunload, and form submission.</p>
    
    <form id="contact-form" data-form-name="Contact Form" onsubmit="handleFormSubmit(event, 'contact-form')">
      <div>
        <label for="contact-email">Email Address *</label>
        <input 
          type="email" 
          id="contact-email" 
          name="email" 
          placeholder="your@email.com" 
          required
          onfocus="logEvent('Focused on email field')"
          onblur="logEvent('Blurred from email field - should trigger form_interaction event', 'blur')"
        >
      </div>

      <div>
        <label for="contact-name">Full Name *</label>
        <input 
          type="text" 
          id="contact-name" 
          name="name" 
          placeholder="John Doe" 
          required
          onfocus="logEvent('Focused on name field')"
          onblur="logEvent('Blurred from name field - should trigger form_interaction event', 'blur')"
        >
      </div>

      <div>
        <label for="contact-phone">Phone Number</label>
        <input 
          type="tel" 
          id="contact-phone" 
          name="phone" 
          placeholder="+1 (555) 123-4567"
          onfocus="logEvent('Focused on phone field')"
          onblur="logEvent('Blurred from phone field - should trigger form_interaction event', 'blur')"
        >
      </div>

      <div>
        <label for="contact-company">Company</label>
        <input 
          type="text" 
          id="contact-company" 
          name="company" 
          placeholder="Acme Inc"
          onfocus="logEvent('Focused on company field')"
          onblur="logEvent('Blurred from company field - should trigger form_interaction event', 'blur')"
        >
      </div>

      <div>
        <label for="contact-inquiry">Inquiry Type</label>
        <select 
          id="contact-inquiry" 
          name="inquiry_type"
          onchange="logEvent('Changed inquiry type - should trigger form_interaction with change trigger', 'change')"
        >
          <option value="">Select...</option>
          <option value="demo">Product Demo</option>
          <option value="pricing">Pricing Information</option>
          <option value="support">Technical Support</option>
          <option value="partnership">Partnership Inquiry</option>
        </select>
      </div>

      <div>
        <label for="contact-message">Message *</label>
        <textarea 
          id="contact-message" 
          name="message" 
          placeholder="Tell us how we can help..." 
          rows="4" 
          required
        ></textarea>
      </div>

      <button type="submit">Send Message</button>
    </form>

    <div class="info-box" style="margin-top: 20px;">
      <strong>üß™ Test Instructions:</strong>
      <ol style="margin: 10px 0 0 0;">
        <li>Open DevTools ‚Üí Network tab ‚Üí Filter by "track"</li>
        <li>Fill email field ‚Üí Click outside ‚Üí See <code>form_interaction</code> event with <code>trigger: "blur"</code></li>
        <li>Fill name field ‚Üí Close tab immediately ‚Üí See <code>form_interaction</code> with <code>trigger: "beforeunload"</code></li>
        <li>Fill entire form ‚Üí Submit ‚Üí See <code>form_submission</code> event with all fields</li>
      </ol>
    </div>
  </div>

  <div class="container">
    <h2>üîí Test Form 2: Sensitive Fields (Privacy Test)</h2>
    <p style="color: #666;">These fields should <strong>NOT</strong> be tracked due to privacy exclusions.</p>
    
    <form id="sensitive-form" data-form-name="Sensitive Fields Test" onsubmit="handleFormSubmit(event, 'sensitive-form')">
      <div>
        <label for="username">Username (tracked)</label>
        <input 
          type="text" 
          id="username" 
          name="username" 
          placeholder="johndoe"
          onblur="logEvent('Blurred from username - SHOULD trigger event', 'blur')"
        >
      </div>

      <div>
        <label for="password">Password (NOT tracked)</label>
        <input 
          type="password" 
          id="password" 
          name="password" 
          placeholder="Enter password"
          onblur="logEvent('Blurred from password - should NOT trigger event (excluded)', 'blur')"
        >
      </div>

      <div>
        <label for="credit-card">Credit Card (NOT tracked)</label>
        <input 
          type="text" 
          id="credit-card" 
          name="credit_card" 
          placeholder="1234 5678 9012 3456"
          onblur="logEvent('Blurred from credit card - should NOT trigger event (excluded)', 'blur')"
        >
      </div>

      <div>
        <label for="ssn">SSN (NOT tracked)</label>
        <input 
          type="text" 
          id="ssn" 
          name="ssn" 
          placeholder="123-45-6789"
          onblur="logEvent('Blurred from SSN - should NOT trigger event (excluded)', 'blur')"
        >
      </div>

      <button type="submit">Submit</button>
    </form>

    <div class="warning-box" style="margin-top: 20px;">
      <strong>‚ö†Ô∏è Expected Behavior:</strong> Only the <code>username</code> field should trigger 
      <code>form_interaction</code> events. Password, credit card, and SSN fields are automatically 
      excluded for privacy and security.
    </div>
  </div>

  <div class="container">
    <h2>üìä Event Log Monitor</h2>
    <p style="color: #666;">Real-time tracking of form interactions and events.</p>
    
    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
      <button onclick="clearEventLog()">üóëÔ∏è Clear Log</button>
      <button onclick="copyEventLog()">üìã Copy Log</button>
    </div>

    <div class="event-log" id="event-log">
      <div>Waiting for events...</div>
    </div>
  </div>

  <div class="container">
    <h2>üìã Full Configuration JSON</h2>
    <pre id="config-json">Click "View Full Config" to load configuration</pre>
  </div>

  <script>
    // Event log
    const eventLog = [];

    function logEvent(message, eventType = '') {
      const timestamp = new Date().toLocaleTimeString();
      const eventClass = eventType || 'info';
      eventLog.push({ timestamp, message, eventType: eventClass });
      
      const logDiv = document.getElementById('event-log');
      const eventDiv = document.createElement('div');
      eventDiv.className = `event ${eventClass}`;
      eventDiv.textContent = `[${timestamp}] ${message}`;
      logDiv.appendChild(eventDiv);
      
      // Auto-scroll to bottom
      logDiv.scrollTop = logDiv.scrollHeight;
      
      console.log(`%c[${timestamp}] ${message}`, `color: ${getEventColor(eventClass)}; font-weight: bold;`);
    }

    function getEventColor(eventType) {
      switch(eventType) {
        case 'blur': return '#28a745';
        case 'beforeunload': return '#ffc107';
        case 'submission': return '#0066cc';
        default: return '#6c757d';
      }
    }

    function clearEventLog() {
      document.getElementById('event-log').innerHTML = '<div>Event log cleared. Waiting for events...</div>';
      eventLog.length = 0;
    }

    function copyEventLog() {
      const text = eventLog.map(e => `[${e.timestamp}] ${e.message}`).join('\n');
      navigator.clipboard.writeText(text);
      alert('‚úÖ Event log copied to clipboard!');
    }

    // Display configuration status
    setTimeout(async () => {
      try {
        const response = await fetch('http://localhost:5000/v1/clients/abc-123');
        const config = await response.json();
        displayConfigStatus(config);
        logEvent('Configuration loaded successfully', 'info');
      } catch (error) {
        console.error('Failed to load config:', error);
        logEvent('‚ö†Ô∏è Failed to load configuration', 'error');
      }
    }, 1000);

    function displayConfigStatus(config) {
      const widgets = config.widgets || {};
      const forms = widgets.forms || {};
      const triggers = forms.triggers || {};
      
      const formsEnabled = forms.enabled;
      const trackInteractions = forms.trackInteractions;
      const blurEnabled = triggers.blur;
      const beforeunloadEnabled = triggers.beforeunload;
      
      // Status display
      const statusHtml = `
        <div class="status ${formsEnabled ? 'status-enabled' : 'status-disabled'}">
          <span style="font-size: 24px;">${formsEnabled ? '‚úÖ' : '‚ùå'}</span>
          <div>
            <strong>Form Tracking:</strong> ${formsEnabled ? 'ENABLED' : 'DISABLED'}
          </div>
        </div>
        <div class="status ${trackInteractions ? 'status-enabled' : 'status-disabled'}">
          <span style="font-size: 24px;">${trackInteractions ? '‚úÖ' : '‚ùå'}</span>
          <div>
            <strong>Field Interaction Tracking:</strong> ${trackInteractions ? 'ENABLED' : 'DISABLED'}
          </div>
        </div>
        <div class="status ${blurEnabled ? 'status-enabled' : 'status-disabled'}">
          <span style="font-size: 24px;">${blurEnabled ? '‚úÖ' : '‚ùå'}</span>
          <div>
            <strong>Blur Trigger:</strong> ${blurEnabled ? 'ENABLED (~85% capture)' : 'DISABLED'}
          </div>
        </div>
        <div class="status ${beforeunloadEnabled ? 'status-enabled' : 'status-disabled'}">
          <span style="font-size: 24px;">${beforeunloadEnabled ? '‚úÖ' : '‚ùå'}</span>
          <div>
            <strong>Beforeunload Trigger:</strong> ${beforeunloadEnabled ? 'ENABLED (~95% capture)' : 'DISABLED'}
          </div>
        </div>
      `;
      
      document.getElementById('status-display').innerHTML = statusHtml;
      
      // Config details
      document.getElementById('config-details').style.display = 'grid';
      document.getElementById('forms-enabled').textContent = formsEnabled ? 'Enabled ‚úÖ' : 'Disabled ‚ùå';
      document.getElementById('track-interactions').textContent = trackInteractions ? 'Enabled ‚úÖ' : 'Disabled ‚ùå';
      document.getElementById('trigger-blur').textContent = blurEnabled ? 'Enabled ‚úÖ' : 'Disabled ‚ùå';
      document.getElementById('trigger-beforeunload').textContent = beforeunloadEnabled ? 'Enabled ‚úÖ' : 'Disabled ‚ùå';
      document.getElementById('track-fields').textContent = (forms.trackFields || []).join(', ') || 'None';
      document.getElementById('batch-size').textContent = forms.batchSize || '10';
    }

    async function enableLeadTracking() {
      try {
        const response = await fetch('http://localhost:5000/v1/clients/abc-123', {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            widgets: {
              forms: {
                enabled: true,
                trackInteractions: true,
                trackFields: ['email', 'phone', 'name', 'first_name', 'last_name', 'company', 'organization'],
                triggers: {
                  blur: true,
                  beforeunload: true,
                  change: true,
                  visibilitychange: false
                },
                excludeFields: ['password', 'ssn', 'credit_card', 'cvv', 'pin'],
                batchSize: 10,
                flushInterval: 5000
              }
            }
          })
        });
        
        if (response.ok) {
          alert('‚úÖ Lead tracking enabled!\n\nConfiguration:\n- blur trigger: ‚úÖ\n- beforeunload trigger: ‚úÖ\n- change trigger: ‚úÖ\n\nReload the page to apply changes.');
          logEvent('Lead tracking configuration updated - ENABLED', 'success');
        } else {
          alert('‚ùå Failed to update configuration');
        }
      } catch (error) {
        console.error('Error:', error);
        alert('‚ùå Error updating configuration');
      }
    }

    async function disableLeadTracking() {
      try {
        const response = await fetch('http://localhost:5000/v1/clients/abc-123', {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            widgets: {
              forms: {
                enabled: false,
                trackInteractions: false
              }
            }
          })
        });
        
        if (response.ok) {
          alert('‚ùå Lead tracking disabled!\n\nReload the page to apply changes.');
          logEvent('Lead tracking configuration updated - DISABLED', 'warning');
        } else {
          alert('‚ùå Failed to update configuration');
        }
      } catch (error) {
        console.error('Error:', error);
        alert('‚ùå Error updating configuration');
      }
    }

    async function viewConfig() {
      try {
        const response = await fetch('http://localhost:5000/v1/clients/abc-123');
        const config = await response.json();
        document.getElementById('config-json').textContent = JSON.stringify(config, null, 2);
        logEvent('Full configuration displayed', 'info');
      } catch (error) {
        console.error('Error:', error);
        document.getElementById('config-json').textContent = 'Error loading configuration';
      }
    }

    function handleFormSubmit(event, formId) {
      event.preventDefault();
      
      const formName = event.target.getAttribute('data-form-name') || formId;
      logEvent(`Form submitted: ${formName}`, 'submission');
      
      const formData = new FormData(event.target);
      const data = {};
      for (let [key, value] of formData.entries()) {
        if (key.includes('password') || key.includes('credit_card') || key.includes('ssn')) {
          data[key] = '[REDACTED]';
        } else {
          data[key] = value;
        }
      }
      
      console.log('%cüìã Form Data:', 'color: #0066cc; font-weight: bold; font-size: 14px;', data);
      
      alert(`‚úÖ ${formName} submitted!\n\nForm ID: ${formId}\n\nCheck the Network tab for form_submission event.`);
      
      event.target.reset();
      logEvent('Form reset. Check Network tab for form_submission event.', 'info');
    }

    // Intercept beforeunload to log it
    window.addEventListener('beforeunload', (e) => {
      console.log('%c‚ö†Ô∏è TAB CLOSING - beforeunload triggered!', 'color: #ffc107; font-weight: bold; font-size: 16px;');
      console.log('This should capture all in-progress form fields and send form_interaction event with trigger=beforeunload');
      // Note: Can't use logEvent here because DOM might be frozen
    });

    // Log when tracker initializes
    setTimeout(() => {
      console.log('%cüéØ Lead-Focused Tracking Test Page Loaded', 'color: #0066cc; font-weight: bold; font-size: 18px;');
      console.log('%cTest Instructions:', 'font-weight: bold; font-size: 14px;');
      console.log('1. Open Network tab ‚Üí Filter by "track"');
      console.log('2. Fill form fields and blur away ‚Üí Watch for form_interaction events');
      console.log('3. Fill fields and close tab ‚Üí Check server logs for beforeunload capture');
      console.log('4. Submit complete form ‚Üí Watch for form_submission event');
      console.log('');
      console.log('%cEvent Types to Watch For:', 'font-weight: bold;');
      console.log('- form_interaction (blur) - When you leave a field');
      console.log('- form_interaction (beforeunload) - When tab closes with in-progress fields');
      console.log('- form_interaction (change) - When dropdown/checkbox changes');
      console.log('- form_submission - When form is submitted');
      console.log('');
      console.log('%cCapture Rate:', 'font-weight: bold;');
      console.log('blur only = ~85%');
      console.log('blur + beforeunload = ~95% ‚úÖ');
      
      logEvent('Test page ready! Start filling forms to see events.', 'info');
    }, 1500);
  </script>
</body>
</html>
